# 社区模块 - 帖子功能说明

## ✅ 已实现的功能

### 1️⃣ 创建帖子
**API**: `POST /community/post`

**请求参数**:
```json
{
  "title": "AI生成的时尚设计分享",
  "content": "今天用DeepWear生成了一款时尚设计...",
  "coverImage": "https://oss.example.com/cover.jpg",
  "postType": 1,
  "imageUrls": [
    "https://oss.example.com/image1.jpg",
    "https://oss.example.com/image2.jpg"
  ],
  "tagIds": [1, 2, 3]
}
```

**字段说明**:
- `title` (必填): 帖子标题，最长200字符
- `content` (必填): 帖子内容
- `coverImage` (可选): 封面图片URL
- `postType` (必填): 帖子类型 (1-图文, 2-纯文字, 3-图片分享)
- `imageUrls` (可选): 图片URL列表
- `tagIds` (可选): 标签ID列表

**返回示例**:
```json
{
  "code": 1,
  "msg": "创建帖子成功",
  "data": 123
}
```

**功能特性**:
- ✅ 自动获取当前登录用户ID
- ✅ 初始化浏览量、点赞数等为0
- ✅ 支持多图上传（按顺序保存）
- ✅ 支持添加标签（自动更新标签使用次数）
- ✅ 事务保证数据一致性

---

### 2️⃣ 获取帖子详情
**API**: `GET /community/post/{id}`

**路径参数**:
- `id`: 帖子ID

**返回示例**:
```json
{
  "code": 1,
  "msg": "操作成功",
  "data": {
    "postId": 123,
    "userId": 456,
    "userName": "fashionLover",
    "nickName": "时尚达人",
    "avatar": "https://oss.example.com/avatar.jpg",
    "title": "AI生成的时尚设计分享",
    "content": "今天用DeepWear生成了一款...",
    "coverImage": "https://oss.example.com/cover.jpg",
    "postType": 1,
    "viewCount": 100,
    "likeCount": 50,
    "commentCount": 20,
    "collectCount": 30,
    "shareCount": 10,
    "status": 0,
    "isTop": 0,
    "isHot": 1,
    "createTime": "2025-10-22T10:30:00",
    "updateTime": "2025-10-22T10:30:00",
    "images": [
      "https://oss.example.com/image1.jpg",
      "https://oss.example.com/image2.jpg"
    ],
    "tags": [
      {
        "tagId": 1,
        "tagName": "AI设计",
        "useCount": 100
      }
    ],
    "isLiked": true,
    "isCollected": false
  }
}
```

**功能特性**:
- ✅ 自动增加浏览量
- ✅ 返回完整的帖子信息（包括图片、标签）
- ✅ 返回作者信息（待集成 Feign 调用）
- ✅ 返回当前用户的点赞/收藏状态
- ✅ 检查帖子状态（已删除的帖子不可查看）

---

### 3️⃣ 更新帖子
**API**: `PUT /community/post/{id}`

**路径参数**:
- `id`: 帖子ID

**请求参数** (所有字段都是可选的):
```json
{
  "title": "新的标题",
  "content": "更新后的内容",
  "coverImage": "https://oss.example.com/new_cover.jpg",
  "postType": 1,
  "imageUrls": [
    "https://oss.example.com/new_image1.jpg"
  ],
  "tagIds": [2, 3]
}
```

**返回示例**:
```json
{
  "code": 1,
  "msg": "更新帖子成功",
  "data": null
}
```

**功能特性**:
- ✅ 权限校验：只能修改自己的帖子
- ✅ 部分更新：只更新提供的字段
- ✅ 图片列表覆盖：如果提供 `imageUrls`，会删除旧图片并保存新图片
- ✅ 标签列表覆盖：如果提供 `tagIds`，会删除旧标签并保存新标签
- ✅ 自动更新 `updateTime`
- ✅ 事务保证数据一致性

---

### 4️⃣ 删除帖子
**API**: `DELETE /community/post/{id}`

**路径参数**:
- `id`: 帖子ID

**返回示例**:
```json
{
  "code": 1,
  "msg": "删除帖子成功",
  "data": null
}
```

**功能特性**:
- ✅ 权限校验：只能删除自己的帖子
- ✅ 软删除：将 `status` 设置为 1，不删除数据库记录
- ✅ 自动更新 `updateTime`
- ✅ 已删除的帖子不可再次删除

---

## 📊 数据库表结构

### post (帖子表)
| 字段 | 类型 | 说明 |
|------|------|------|
| post_id | BIGINT | 主键，自增 |
| user_id | BIGINT | 发帖用户ID |
| title | VARCHAR(200) | 帖子标题 |
| content | TEXT | 帖子内容 |
| cover_image | VARCHAR(500) | 封面图片URL |
| post_type | TINYINT | 帖子类型：1-图文 2-纯文字 3-图片分享 |
| view_count | INT | 浏览量 |
| like_count | INT | 点赞数 |
| comment_count | INT | 评论数 |
| collect_count | INT | 收藏数 |
| share_count | INT | 分享数 |
| status | TINYINT | 状态：0-正常 1-删除 2-审核中 3-违规 |
| is_top | TINYINT | 是否置顶：0-否 1-是 |
| is_hot | TINYINT | 是否热门：0-否 1-是 |
| create_time | DATETIME | 创建时间 |
| update_time | DATETIME | 更新时间 |

### post_image (帖子图片关联表)
| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT | 主键，自增 |
| post_id | BIGINT | 帖子ID |
| image_id | BIGINT | 图片ID（关联image表，可选） |
| image_url | VARCHAR(500) | 图片URL |
| sort_order | INT | 排序顺序 |
| create_time | DATETIME | 创建时间 |

### post_tag (帖子标签关联表)
| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT | 主键，自增 |
| post_id | BIGINT | 帖子ID |
| tag_id | BIGINT | 标签ID |
| create_time | DATETIME | 创建时间 |

---

## 🔧 技术实现细节

### 权限控制
- 使用 `UserContext.getCurrentUserId()` 获取当前登录用户
- 创建帖子：自动关联到当前用户
- 更新帖子：校验是否为帖子作者
- 删除帖子：校验是否为帖子作者

### 事务管理
- 使用 `@Transactional` 保证数据一致性
- 创建/更新帖子时，同时操作 post、post_image、post_tag 三张表
- 任何一步失败都会回滚

### 软删除
- 删除帖子时，只修改 `status` 字段为 1
- 保留数据便于后续审计和恢复
- 已删除的帖子不会在列表中显示

### 计数器更新
- 浏览量：每次查看帖子详情时 +1
- 标签使用次数：创建帖子时关联标签会 +1

---

## 🚀 待实现功能

### 1️⃣ Feign 集成
**文件**: `PostServiceImpl.java` 第295-300行

需要集成 User 模块的 Feign Client，获取用户信息：
```java
// TODO: 通过 Feign 调用 User 模块获取用户信息
// User author = userClient.getUserById(post.getUserId()).getData();
// vo.setUserName(author.getUserName());
// vo.setNickName(author.getNickName());
// vo.setAvatar(author.getAvatar());
```

### 2️⃣ 帖子列表功能
- `GET /community/posts` - 获取帖子列表（分页、筛选）
- `GET /community/posts/hot` - 获取热门帖子
- `GET /community/posts/following` - 获取关注用户的帖子

### 3️⃣ 其他功能
- 点赞/取消点赞
- 收藏/取消收藏
- 评论功能
- 分享功能
- 标签管理

---

## 📝 使用示例

### 创建帖子
```bash
curl -X POST http://localhost:8083/community/post \
  -H "Content-Type: application/json" \
  -H "Authorization: your-access-token" \
  -d '{
    "title": "AI生成的时尚设计",
    "content": "这是我用DeepWear生成的设计...",
    "coverImage": "https://oss.example.com/cover.jpg",
    "postType": 1,
    "imageUrls": ["https://oss.example.com/img1.jpg"],
    "tagIds": [1, 2]
  }'
```

### 获取帖子详情
```bash
curl -X GET http://localhost:8083/community/post/123 \
  -H "Authorization: your-access-token"
```

### 更新帖子
```bash
curl -X PUT http://localhost:8083/community/post/123 \
  -H "Content-Type: application/json" \
  -H "Authorization: your-access-token" \
  -d '{
    "title": "新的标题"
  }'
```

### 删除帖子
```bash
curl -X DELETE http://localhost:8083/community/post/123 \
  -H "Authorization: your-access-token"
```

---

## ⚠️ 注意事项

1. **认证要求**: 所有接口都需要登录，通过 Gateway 传递 `userId` 到 ThreadLocal
2. **权限控制**: 只能修改/删除自己的帖子
3. **数据校验**: 使用 `@Valid` 注解进行参数校验
4. **异常处理**: 统一通过 `GlobalExceptionHandler` 处理异常
5. **软删除**: 删除的帖子 `status=1`，不会真正删除数据

---

## 🎯 下一步开发建议

1. **集成 Feign Client**: 调用 User 模块获取用户信息
2. **实现帖子列表**: 支持分页、筛选、排序
3. **添加缓存**: 使用 Redis 缓存热门帖子和帖子详情
4. **性能优化**: 添加数据库索引，优化查询性能
5. **完善权限**: 添加管理员权限（可以删除任何帖子）

